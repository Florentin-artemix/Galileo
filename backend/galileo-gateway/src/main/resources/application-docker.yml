spring:
  # Configuration pour les uploads volumineux
  codec:
    max-in-memory-size: 50MB
  
  cloud:
    gateway:
      routes:
        # Profil équipe (GET/POST authentifié) - AVANT les routes publiques !
        - id: team-profile
          uri: ${LECTURE_SERVICE_URL:http://lecture:8081}
          predicates:
            - Path=/api/team/profile/**
          filters:
            - StripPrefix=1
            - name: FirebaseAuthenticationFilter
          order: -10
        
        # Publications, Blog, Événements, Équipe, Recherche (GET public)
        - id: service-lecture-public
          uri: ${LECTURE_SERVICE_URL:http://lecture:8081}
          predicates:
            - Path=/api/publications/**,/api/articles/**,/api/blog/**,/api/events/**,/api/team/**,/api/search/**
            - Method=GET
          filters:
            - StripPrefix=1
        
        # Upload images blog vers Cloudflare R2 (service-ecriture)
        - id: blog-upload-image
          uri: ${ECRITURE_SERVICE_URL:http://ecriture:8082}
          predicates:
            - Path=/api/blog/upload-image
            - Method=POST
          filters:
            - StripPrefix=1
            - name: FirebaseAuthenticationFilter
          order: -5
        
        # Événements, Blog et Équipe (POST/PUT/DELETE - authentifié)
        - id: service-lecture-admin
          uri: ${LECTURE_SERVICE_URL:http://lecture:8081}
          predicates:
            - Path=/api/events/**,/api/blog/**,/api/team/**
            - Method=POST,PUT,DELETE
          filters:
            - StripPrefix=1
            - name: FirebaseAuthenticationFilter
        
        # Indexation (POST)
        - id: service-lecture-indexation
          uri: ${LECTURE_SERVICE_URL:http://lecture:8081}
          predicates:
            - Path=/api/indexation/**
          filters:
            - StripPrefix=1
        
        # Page équipe publique (STAFF + ADMIN depuis PostgreSQL)
        - id: public-team
          uri: ${ECRITURE_SERVICE_URL:http://ecriture:8082}
          predicates:
            - Path=/api/public/team/**
            - Method=GET
          filters:
            - StripPrefix=1
          order: -5
        
        # Auto-inscription publique (sans vérification de rôle)
        - id: self-register
          uri: ${ECRITURE_SERVICE_URL:http://ecriture:8082}
          predicates:
            - Path=/api/admin/users/self-register
            - Method=POST
          filters:
            - StripPrefix=1
            - name: FirebaseAuthenticationFilter
          order: 0
        
        # Upload/gestion des photos de profil
        - id: profile-photos
          uri: ${ECRITURE_SERVICE_URL:http://ecriture:8082}
          predicates:
            - Path=/api/profile/**
          filters:
            - StripPrefix=1
            - name: FirebaseAuthenticationFilter
        
        # Service Écriture - Modération Staff
        - id: staff-moderation
          uri: ${ECRITURE_SERVICE_URL:http://ecriture:8082}
          predicates:
            - Path=/api/staff/**
          filters:
            - StripPrefix=1
            - name: FirebaseAuthenticationFilter
          order: -5
        
        # Service Écriture - Dashboard Étudiant
        - id: student-dashboard
          uri: ${ECRITURE_SERVICE_URL:http://ecriture:8082}
          predicates:
            - Path=/api/student/**
          filters:
            - StripPrefix=1
            - name: FirebaseAuthenticationFilter
          order: -5
        
        # Service Écriture
        - id: service-ecriture
          uri: ${ECRITURE_SERVICE_URL:http://ecriture:8082}
          predicates:
            - Path=/api/soumissions/**,/api/admin/**
          filters:
            - StripPrefix=1
            - name: FirebaseAuthenticationFilter
        
        # ============================================
        # NOUVEAUX SERVICES - Extension Architecture
        # Les routes spécifiques AVANT /api/users/**
        # ============================================
        
        # Service Notification - Notifications utilisateur (authentifié)
        - id: notification-service
          uri: ${NOTIFICATION_SERVICE_URL:http://notification:8084}
          predicates:
            - Path=/api/notifications/**
          filters:
            - StripPrefix=0
            - name: FirebaseAuthenticationFilter
        
        # Service Analytics - Dashboard stats (authentifié admin)
        - id: analytics-dashboard
          uri: ${ANALYTICS_SERVICE_URL:http://analytics:8085}
          predicates:
            - Path=/api/analytics/**
            - Method=GET
          filters:
            - StripPrefix=0
            - name: FirebaseAuthenticationFilter
        
        # Service Analytics - Tracking (public pour tracking)
        - id: analytics-tracking
          uri: ${ANALYTICS_SERVICE_URL:http://analytics:8085}
          predicates:
            - Path=/api/analytics/**
            - Method=POST
          filters:
            - StripPrefix=0
        
        # Service User Profile - Favoris
        - id: userprofile-favorites
          uri: ${USERPROFILE_SERVICE_URL:http://userprofile:8083}
          predicates:
            - Path=/api/users/*/favorites/**
          filters:
            - StripPrefix=0
            - name: FirebaseAuthenticationFilter

        # Service User Profile - Favoris (sans slash final)
        - id: userprofile-favorites-root
          uri: ${USERPROFILE_SERVICE_URL:http://userprofile:8083}
          predicates:
            - Path=/api/users/*/favorites
          filters:
            - StripPrefix=0
            - name: FirebaseAuthenticationFilter

        # Service User Profile - Historique
        - id: userprofile-history
          uri: ${USERPROFILE_SERVICE_URL:http://userprofile:8083}
          predicates:
            - Path=/api/users/*/history/**
          filters:
            - StripPrefix=0
            - name: FirebaseAuthenticationFilter

        # Service User Profile - Historique (sans slash final)
        - id: userprofile-history-root
          uri: ${USERPROFILE_SERVICE_URL:http://userprofile:8083}
          predicates:
            - Path=/api/users/*/history
          filters:
            - StripPrefix=0
            - name: FirebaseAuthenticationFilter

        # Service User Profile - Profil
        - id: userprofile-profile
          uri: ${USERPROFILE_SERVICE_URL:http://userprofile:8083}
          predicates:
            - Path=/api/users/*/profile/**
          filters:
            - StripPrefix=0
            - name: FirebaseAuthenticationFilter

        # Service User Profile - Profil (sans slash final)
        - id: userprofile-profile-root
          uri: ${USERPROFILE_SERVICE_URL:http://userprofile:8083}
          predicates:
            - Path=/api/users/*/profile
          filters:
            - StripPrefix=0
            - name: FirebaseAuthenticationFilter

        # Service User Profile - Profils, Favoris, Historique (authentifié)
        - id: userprofile-service
          uri: ${USERPROFILE_SERVICE_URL:http://userprofile:8083}
          predicates:
            - Path=/api/userprofile/**
          filters:
            - StripPrefix=1
            - RewritePath=/api/userprofile/(?<segment>.*), /api/users/${segment}
            - name: FirebaseAuthenticationFilter

        # Profil utilisateur de base (/api/users/me) - DOIT être en DERNIER
        # car /api/users/** matche tout
        - id: ecriture-users
          uri: ${ECRITURE_SERVICE_URL:http://ecriture:8082}
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=1
            - name: FirebaseAuthenticationFilter

firebase:
  enabled: true
  credentials:
    path: config/firebase-credentials.json
